{% extends "core/admin_base.html" %}
{% load static %}

{% block title %}Create Check-In | 15-Five{% endblock %}

{% block content %}

<div class="mb-4">
    <h1 class="fw-bold">Create Check-In</h1>
    <p class="text-muted">Configure and send a new check-in to your team</p>
</div>

<form method="post">
    {% csrf_token %}

    <!-- ================= CHECK-IN CONFIG ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-4">Check-In Configuration</h5>

            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Check-In Period</label>
                    <select name="period" class="form-select" required>
                        <option value="WEEKLY">Weekly</option>
                        <option value="MONTHLY">Monthly</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Start Date</label>
                    <input type="date" name="start_date" class="form-control" required>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= ASSIGN TO EMPLOYEE ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-3">Assign Check-In To</h5>

            <select name="employee" class="form-select" required>
                <option value="ALL">All Employees</option>
                {% for emp in employees %}
                    <option value="{{ emp.id }}">
                        {{ emp.employee_profile.full_name|default:emp.email }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- ================= DEFAULT QUESTIONS ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <h5 class="fw-semibold mb-4">Default Questions</h5>

            <div id="default-questions-container">
                {% for q in questions %}
                <div class="d-flex justify-content-between align-items-center mb-3">

                    <div class="form-check">
                        <input class="form-check-input question-checkbox"
                               type="checkbox"
                               name="questions"
                               value="{{ q.id }}">
                        <label class="form-check-label fw-medium">
                            {{ q.question_text }}
                        </label>
                    </div>

                    <div class="d-flex gap-2">
                        <button type="button"
                            class="btn btn-sm btn-outline-secondary"
                            onclick="editDefaultQuestion('${data.id}', '${data.question_text}')">
                            Edit
                        </button>
                    
                        <button type="button"
        class="btn btn-sm btn-outline-secondary"
        onclick="deleteDefaultQuestion('{{ q.id }}')">
    Delete
</button>

                    </div>
                    
                </div>
                {% endfor %}
            </div>

            <!-- ADD DEFAULT QUESTION -->
            <div class="mt-4">
                <h6 class="fw-semibold mb-2">Add Default Question</h6>

                <div class="d-flex gap-2">
                    <input type="text"
                           id="default-question-input"
                           class="form-control"
                           placeholder="Enter default question">
                    <button type="button"
                            class="btn btn-outline-primary"
                            onclick="addDefaultQuestion()">
                        Add
                    </button>
                </div>
            </div>

            <hr class="my-4">

            <h6 class="fw-semibold mb-2">Custom Questions</h6>
            <div id="custom-questions"></div>

            <button type="button"
                    class="btn btn-outline-primary mt-2"
                    onclick="addCustomQuestion()">
                + Add Custom Question
            </button>

        </div>
    </div>

    <div class="d-flex justify-content-end gap-3">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary px-4">
            Cancel
        </a>
        <button type="submit" class="btn btn-primary px-4">
            Send Check-In
        </button>
    </div>
</form>

<!-- ✅ SINGLE GLOBAL DELETE FORM -->
<form method="post"
      id="delete-default-question-form"
      class="delete-form"
      data-message="This default question will be removed from all future check-ins.">
    {% csrf_token %}
    <input type="hidden" name="delete_question_id" id="delete_question_id">
</form>

{% endblock %}

{% block scripts %}
<script>
function deleteDefaultQuestion(id) {
    const form = document.getElementById("delete-default-question-form");
    document.getElementById("delete_question_id").value = id;

    // ✅ Proper native submit (SweetAlert will intercept)
    form.requestSubmit();
}


function addDefaultQuestion() {
    const input = document.getElementById("default-question-input");
    const text = input.value.trim();

    if (!text) {
        Swal.fire("Error", "Question cannot be empty.", "error");
        return;
    }

    fetch("", {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded",
        },
        body: new URLSearchParams({
            add_question: "1",
            question_text: text
        })
    })
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById("default-questions-container");

        const div = document.createElement("div");
        div.className = "d-flex justify-content-between align-items-center mb-3";
        div.innerHTML = `
            <div class="form-check">
                <input class="form-check-input question-checkbox"
                       type="checkbox"
                       name="questions"
                       value="${data.id}">
                <label class="form-check-label fw-medium">
                    ${data.question_text}
                </label>
            </div>
            <div class="d-flex gap-2">
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        onclick="editDefaultQuestion('${data.id}', '${data.question_text}')">
                    Edit
                </button>
                <button type="button"
                        class="btn btn-sm btn-outline-secondary"
                        onclick="deleteDefaultQuestion('${data.id}')">
                    Delete
                </button>
            </div>
        `;
        container.appendChild(div);
        input.value = "";
    });
}

function editDefaultQuestion(id, text) {
    const newText = prompt("Edit default question:", text);
    if (!newText) return;

    const form = document.createElement("form");
    form.method = "POST";
    form.innerHTML = `
        {% csrf_token %}
        <input type="hidden" name="edit_question_id" value="${id}">
        <input type="hidden" name="edit_question_text" value="${newText}">
    `;
    document.body.appendChild(form);
    form.submit();
}

function addCustomQuestion() {
    const container = document.getElementById("custom-questions");
    const wrapper = document.createElement("div");
    wrapper.className = "d-flex gap-2 mt-3";
    wrapper.innerHTML = `
        <input type="text" name="custom_questions[]" class="form-control" required>
        <button type="button" class="btn btn-outline-secondary"
                onclick="this.parentElement.remove()">Remove</button>
    `;
    container.appendChild(wrapper);
}
</script>
{% endblock %}
