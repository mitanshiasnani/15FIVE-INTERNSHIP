{% extends "core/admin_base.html" %}
{% load static %}

{% block title %}Create Check-In | 15-Five{% endblock %}

{% block content %}

<div class="mb-4">
    <h1 class="fw-bold">Create Check-In</h1>
    <p class="text-muted">Configure and send a new check-in to your team</p>
</div>

<form method="post">
    {% csrf_token %}

    <!-- ================= CHECK-IN CONFIG ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="fw-semibold mb-4">Check-In Configuration</h5>

            <div class="row g-4">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Check-In Period</label>
                    <select name="period" class="form-select" required>
                        <option value="WEEKLY">Weekly</option>
                        <option value="MONTHLY">Monthly</option>
                    </select>
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-semibold">Start Date</label>
                    <input type="date" name="start_date" class="form-control" required>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= QUESTIONS ================= -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">

            <!-- Header + Select All button (design preserved) -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="fw-semibold mb-0">Questions</h5>

                <button
                    type="button"
                    id="selectAllQuestionsBtn"
                    class="btn btn-sm btn-outline-primary"
                    onclick="toggleSelectAllQuestions()"
                >
                    Select All
                </button>
            </div>

            {% if error %}
                <div class="alert alert-danger">{{ error }}</div>
            {% endif %}

            <!-- Default Questions -->
            {% for q in questions %}
            <div class="form-check mb-3">
                <input
                    class="form-check-input question-checkbox"
                    type="checkbox"
                    name="questions"
                    value="{{ q.id }}"
                    id="question_{{ q.id }}"
                >
                <label class="form-check-label fw-medium" for="question_{{ q.id }}">
                    {{ q.question_text }}
                </label>
            </div>
            {% endfor %}

            <!-- Custom Questions -->
            <div id="custom-questions"></div>

            <button
                type="button"
                class="btn btn-outline-primary mt-3"
                onclick="addQuestion()"
            >
                + Add Custom Question
            </button>
        </div>
    </div>

    <!-- ================= ACTION BUTTONS ================= -->
    <div class="d-flex justify-content-end gap-3">
        <a href="{% url 'admin_dashboard' %}" class="btn btn-outline-secondary px-4">
            Cancel
        </a>
        <button type="submit" class="btn btn-primary px-4">
            Send Check-In
        </button>
    </div>
</form>

{% endblock %}

{% block scripts %}
<script>
/* ================= SELECT ALL QUESTIONS ================= */

function toggleSelectAllQuestions() {
    const checkboxes = document.querySelectorAll('.question-checkbox');
    const button = document.getElementById('selectAllQuestionsBtn');

    if (!checkboxes.length) return;

    const allChecked = Array.from(checkboxes).every(cb => cb.checked);

    checkboxes.forEach(cb => {
        cb.checked = !allChecked;
    });

    button.textContent = allChecked ? 'Select All' : 'Unselect All';
}

/* Reset button text if user manually changes any checkbox */
document.addEventListener('change', function (e) {
    if (e.target.classList.contains('question-checkbox')) {
        document.getElementById('selectAllQuestionsBtn').textContent = 'Select All';
    }
});

/* ================= CUSTOM QUESTIONS ================= */

function addQuestion() {
    const container = document.getElementById('custom-questions');

    const wrapper = document.createElement('div');
    wrapper.className = 'd-flex gap-2 mt-3';

    wrapper.innerHTML = `
        <input
            type="text"
            name="custom_questions[]"
            class="form-control question-checkbox"
            placeholder="Enter custom question"
            required
        >
        <button
            type="button"
            class="btn btn-outline-danger"
            onclick="this.parentElement.remove()"
        >âœ•</button>
    `;

    container.appendChild(wrapper);
}
</script>
{% endblock %}
